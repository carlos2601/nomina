<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cálculo de Jornada Laboral</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --danger: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            padding: 10px;
            width: 100%;
            min-width: 320px;
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 15px;
            width: 100%;
            overflow-x: auto;
        }

        h1, h2, h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-weight: 600;
            word-break: break-word;
        }

        h1 {
            font-size: 22px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            padding-bottom: 10px;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: var(--accent);
            border-radius: 2px;
        }

        h2 {
            font-size: 18px;
            border-left: 3px solid var(--accent);
            padding-left: 8px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            width: 100%;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .inline-fields {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .btn {
            display: inline-block;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d1145a;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3ab0d6;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            font-size: 13px;
            min-width: 300px;
        }

        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-break: break-word;
        }

        th {
            background-color: var(--primary);
            color: white;
            font-weight: 500;
            font-size: 13px;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #f1f3ff;
        }

        .total-row {
            font-weight: 600;
            background-color: #e9ecef !important;
        }

        .highlight {
            background-color: #fff3cd !important;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .jornada-container {
            margin-bottom: 20px;
            width: 100%;
        }

        .jornada-item {
            position: relative;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 3px solid var(--accent);
            width: 100%;
        }

        .remove-jornada {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
        }

        .benefits-card {
            background-color: #e6f7ed;
            border-left: 3px solid #28a745;
        }

        .deductions-card {
            background-color: #fde8e8;
            border-left: 3px solid var(--danger);
        }

        .summary-card {
            background-color: #e9f7fe;
            border-left: 3px solid var(--success);
        }

        .marquee {
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
            font-size: 13px;
            width: 100%;
        }

        small {
            font-size: 12px;
            color: var(--gray);
        }

        @media (min-width: 600px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            h2 {
                font-size: 20px;
            }

            .inline-fields {
                flex-direction: row;
            }

            .btn-group {
                flex-direction: row;
            }

            .btn {
                width: auto;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CALCULAR JORNADA LABORAL</h1>

        <div class="card">
            <div class="form-group">
                <label for="salarioBase">Salario Básico Mensual:</label>
                <input type="number" id="salarioBase" placeholder="Ingrese el salario básico">
                <small>(Se usa para calcular el valor hora)</small>
            </div>
            <div class="form-group">
                <label for="diasDescanso">Número de Días de Descanso Remunerado:</label>
                <input type="number" id="diasDescanso" placeholder="Ingrese número de días">
                <small>(Se multiplicará por el valor de un día básico)</small>
            </div>
            <div class="form-group">
                <label for="valorRodamientoDiario">Valor Rodamiento Diario:</label>
                <input type="number" id="valorRodamientoDiario" placeholder="Ingrese el valor diario de rodamiento">
                <small>(Se multiplicará por el número de jornadas calculadas)</small>
            </div>

            <div id="jornadas-container">
                <!-- Jornadas se agregarán aquí dinámicamente -->
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-success" onclick="agregarJornada()">+ Agregar Jornada</button>
                <button type="button" class="btn btn-primary" onclick="calcularTodasJornadas()">Calcular Todas</button>
                <button type="button" class="btn btn-danger" onclick="resetTodo()">Borrar Todo</button>
                <button type="button" class="btn btn-primary" id="btnGuardarProgreso">Guardar Progreso</button>
                <button type="button" class="btn btn-success" id="btnImportarProgreso">Importar Progreso</button>
                <button type="button" class="btn btn-secondary" id="btnTogglePrestaciones">Prestaciones: ON</button>
            </div>
        </div>

        <div class="card" id="resultados-container" style="display: none;">
            <h2>DESGLOSE DE HORAS Y RECARGOS</h2>
            <div style="overflow-x: auto;">
                <table id="tabla-resultados">
                    <thead>
                        <tr>
                            <th>Tipo de Jornada</th>
                            <th class="text-center">Horas</th>
                            <th class="text-right">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Ordinaria 0%</td><td class="text-center" id="horasOrdinarias">0</td><td class="text-right" id="valorOrdinario">$0</td></tr>
                        <tr><td>Nocturna 35%</td><td class="text-center" id="horasNocturnas">0</td><td class="text-right" id="valorNocturno">$0</td></tr>
                        <tr><td>Extras Diurnas 25%</td><td class="text-center" id="extrasDiurnas">0</td><td class="text-right" id="valorExtrasDiurnas">$0</td></tr>
                        <tr><td>Extras Nocturnas 75%</td><td class="text-center" id="extrasNocturnas">0</td><td class="text-right" id="valorExtrasNocturnas">$0</td></tr>
                        <tr><td>Festiva Diurna 100%</td><td class="text-center" id="festivaDiurna">0</td><td class="text-right" id="valorFestivaDiurna">$0</td></tr>
                        <tr><td>Festiva Nocturna 110%</td><td class="text-center" id="festivaNocturna">0</td><td class="text-right" id="valorFestivaNocturna">$0</td></tr>
                        <tr><td>Extra Festiva 150%</td><td class="text-center" id="horaExtraFestiva">0</td><td class="text-right" id="valorExtraFestiva">$0</td></tr>
                        <tr class="total-row"><td class="text-right" colspan="2">Total Devengado</td><td class="text-right" id="detalleTotal">$0</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card benefits-card" id="beneficios-container" style="display: none;">
            <h2>PRESTACIONES SOCIALES</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th class="text-right">%</th>
                            <th class="text-right">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Prima de Servicios</td><td class="text-right">8.33%</td><td class="text-right" id="prima">$0</td></tr>
                        <tr><td>Cesantías</td><td class="text-right">8.33%</td><td class="text-right" id="cesantias">$0</td></tr>
                        <tr><td>Int. Cesantías</td><td class="text-right">1%</td><td class="text-right" id="intereses-cesantias">$0</td></tr>
                        <tr class="total-row"><td class="text-right" colspan="2">Total Prestaciones</td><td class="text-right" id="total-prestaciones">$0</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card deductions-card" id="deducciones-container" style="display: none;">
            <h2>DEDUCCIONES</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th class="text-right">%</th>
                            <th class="text-right">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Salud (Empleado)</td><td class="text-right">4%</td><td class="text-right" id="salud-empleado">$0</td></tr>
                        <tr><td>Pensión (Empleado)</td><td class="text-right">4%</td><td class="text-right" id="pension-empleado">$0</td></tr>
                        <tr class="total-row"><td class="text-right" colspan="2">Total Deducciones</td><td class="text-right" id="total-deducciones">$0</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card summary-card" id="resumen-container" style="display: none;">
            <h2>RESUMEN DE PAGO</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th class="text-right">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Total Devengado</td><td class="text-right" id="resumen-devengado">$0</td></tr>
                        <tr><td>Total Prestaciones</td><td class="text-right" id="resumen-prestaciones">$0</td></tr>
                        <tr><td>Total Deducciones</td><td class="text-right" id="resumen-deducciones">$0</td></tr>
                        <tr><td>Descanso Remunerado</td><td class="text-right" id="resumen-descanso-remunerado">$0</td></tr>
                        <tr><td>Rodamiento</td><td class="text-right" id="resumen-rodamientos">$0</td></tr>
                        <tr><td>Subsidio de Transporte</td><td class="text-right" id="resumen-subsidio-transporte">$0</td></tr>
                        <tr class="total-row highlight"><td>NETO A PAGAR</td><td class="text-right" id="neto-pagar">$0</td></tr>
                    </tbody>
                </table>
            </div>
        </div>



        <p style="text-align:center; margin-top:15px; font-size:13px; color:var(--gray);">
            ¿Quieres calcular el resultado de tu prima y cesantías?
            <a href="https://carlos2601.github.io/cesant-as-primas/" style="color:var(--accent); text-decoration:none; font-weight:bold;">
                Da click aquí.
            </a>
        </p>
    </div>
    <input type="file" id="importFile" accept=".json" style="display: none;">
    <script>
        // Festivos 2025
        const festivos2025 = [
            '2025-01-01', '2025-01-05', '2025-01-06', '2025-01-12', '2025-01-19', '2025-01-26',
            '2025-02-02', '2025-02-09', '2025-02-16', '2025-02-23',
            '2025-03-02', '2025-03-09', '2025-03-16', '2025-03-23', '2025-03-24', '2025-03-30',
            '2025-04-06', '2025-04-13', '2025-04-17', '2025-04-18', '2025-04-20', '2025-04-27',
            '2025-05-01', '2025-05-04', '2025-05-11', '2025-05-18', '2025-05-25',
            '2025-06-01', '2025-06-02', '2025-06-08', '2025-06-15', '2025-06-22', '2025-06-23', '2025-06-29', '2025-06-30',
            '2025-07-06', '2025-07-13', '2025-07-20', '2025-07-27',
            '2025-08-03', '2025-08-07', '2025-08-10', '2025-08-17', '2025-08-18', '2025-08-24', '2025-08-31',
            '2025-09-07', '2025-09-14', '2025-09-21', '2025-09-28',
            '2025-10-05', '2025-10-12', '2025-10-13', '2025-10-19', '2025-10-26',
            '2025-11-02', '2025-11-03', '2025-11-09', '2025-11-16', '2025-11-17', '2025-11-23', '2025-11-30',
            '2025-12-07', '2025-12-08', '2025-12-14', '2025-12-21', '2025-12-25', '2025-12-28'
        ];

        const SALARIO_MINIMO_COLOMBIA = 1300000; // COP
        const SUBSIDIO_TRANSPORTE_MONTO = 200000; // COP

        // Variables globales para acumular resultados de múltiples jornadas
        let totalHorasOrdinarias = 0;
        let totalHorasNocturnas = 0;
        let totalExtrasDiurnas = 0;
        let totalExtrasNocturnas = 0;
        let totalFestivaDiurna = 0;
        let totalFestivaNocturna = 0;
        let totalExtraFestiva = 0;
        let totalDevengado = 0;
        let contadorJornadas = 0;
        let salarioBase = 0;
        let prestacionesActivas = true;

        // Función para obtener la fecha actual con hora fija a las 17:00
        function obtenerFechaActual() {
            const ahora = new Date();
            // Formato: YYYY-MM-DD con hora fija 17:00
            const fecha = ahora.getFullYear() + '-' +
                         String(ahora.getMonth() + 1).padStart(2, '0') + '-' +
                         String(ahora.getDate()).padStart(2, '0') + 'T17:00';
            return fecha;
        }

        // Función para obtener la fecha del día siguiente con hora fija a las 07:00
        function obtenerFechaSiguienteDia() {
            const ahora = new Date();
            const manana = new Date(ahora);
            manana.setDate(ahora.getDate() + 1);
            // Formato: YYYY-MM-DD con hora fija 07:00
            const fecha = manana.getFullYear() + '-' +
                         String(manana.getMonth() + 1).padStart(2, '0') + '-' +
                         String(manana.getDate()).padStart(2, '0') + 'T07:00';
            return fecha;
        }

        // Función para agregar una nueva jornada (sin botón individual)
        function agregarJornada() {
            contadorJornadas++;
            const jornadaId = 'jornada-' + contadorJornadas;

            const jornadaHTML = `
                <div class="jornada-item" id="${jornadaId}">
                    <button class="remove-jornada" onclick="eliminarJornada('${jornadaId}')">×</button>
                    <h3>Jornada ${contadorJornadas}</h3>
                    <div class="inline-fields">
                        <div class="form-group">
                            <label for="${jornadaId}-fechaIngreso">Fecha y Hora de Ingreso:</label>
                            <input type="datetime-local" id="${jornadaId}-fechaIngreso" value="${obtenerFechaActual()}">
                        </div>
                        <div class="form-group">
                            <label for="${jornadaId}-fechaSalida">Fecha y Hora de Salida:</label>
                            <input type="datetime-local" id="${jornadaId}-fechaSalida" value="${obtenerFechaSiguienteDia()}">
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('jornadas-container').insertAdjacentHTML('beforeend', jornadaHTML);
        }

        // Función para eliminar una jornada
        function eliminarJornada(jornadaId) {
            const jornadaElement = document.getElementById(jornadaId);
            if (jornadaElement) {
                jornadaElement.remove();
                // Reorganizar los números de jornada si es necesario
                reorganizarJornadas();
            }
        }

        // Función para reorganizar los números de jornada después de eliminar una
        function reorganizarJornadas() {
            const jornadas = document.querySelectorAll('.jornada-item');
            let nuevoContador = 0;

            jornadas.forEach(jornada => {
                nuevoContador++;
                const jornadaId = jornada.id;
                const titulo = jornada.querySelector('h3');
                if (titulo) titulo.textContent = `Jornada ${nuevoContador}`;
            });

            contadorJornadas = nuevoContador;
        }

        // Función para calcular una jornada individual (sin alert)
        function calcularJornada(jornadaId) {
            // Validar que el salario base esté ingresado
            salarioBase = parseFloat(document.getElementById('salarioBase').value) || 0;
            if (salarioBase <= 0) {
                return;
            }

            const ingreso = new Date(document.getElementById(`${jornadaId}-fechaIngreso`).value);
            const salida = new Date(document.getElementById(`${jornadaId}-fechaSalida`).value);

            if (!ingreso || !salida) {
                return;
            }

            let horasOrdinarias = 0, horasNocturnas = 0;
            let extrasDiurnas = 0, extrasNocturnas = 0;
            let festivaDiurna = 0, festivaNocturna = 0, extraFestiva = 0;

            const horaValor = salarioBase / 240;
            const recargos = {
                nocturna: 0.35,
                extraDiurna: 0.25,
                extraNocturna: 0.75,
                festivaDiurna: 1.00,
                festivaNocturna: 1.10,
                extraFestiva: 1.50,
            };

            let horaActual = new Date(ingreso);
            let horasAcumuladas = 0;

            while (horaActual < salida) {
                const siguiente = new Date(horaActual);
                siguiente.setHours(siguiente.getHours() + 1);
                const hora = horaActual.getHours();

                const fechaStr = horaActual.getFullYear() + '-' +
                    String(horaActual.getMonth() + 1).padStart(2, '0') + '-' +
                    String(horaActual.getDate()).padStart(2, '0');

                const esFestivo = festivos2025.includes(fechaStr);
                const esNocturna = (hora >= 21 || hora < 6);
                const esDiurna = !esNocturna;
                const esExtra = horasAcumuladas >= 8;

                if (esFestivo && esExtra) {
                    extraFestiva++;
                } else if (esFestivo && esNocturna) {
                    festivaNocturna++;
                } else if (esFestivo && esDiurna) {
                    festivaDiurna++;
                } else if (esExtra && esNocturna) {
                    extrasNocturnas++;
                } else if (esExtra && esDiurna) {
                    extrasDiurnas++;
                } else if (esNocturna) {
                    horasNocturnas++;
                } else {
                    horasOrdinarias++;
                }

                horasAcumuladas++;
                horaActual = siguiente;
            }

            // Acumular resultados para mostrar en la tabla general
            totalHorasOrdinarias += horasOrdinarias;
            totalHorasNocturnas += horasNocturnas;
            totalExtrasDiurnas += extrasDiurnas;
            totalExtrasNocturnas += extrasNocturnas;
            totalFestivaDiurna += festivaDiurna;
            totalFestivaNocturna += festivaNocturna;
            totalExtraFestiva += extraFestiva;
        }

        // Función para calcular todas las jornadas
        function calcularTodasJornadas() {
            // Validar que el salario base esté ingresado
            salarioBase = parseFloat(document.getElementById('salarioBase').value) || 0;
            if (salarioBase <= 0) {
                alert('Por favor, ingrese el salario básico primero.');
                return;
            }

            // Resetear acumuladores
            totalHorasOrdinarias = 0;
            totalHorasNocturnas = 0;
            totalExtrasDiurnas = 0;
            totalExtrasNocturnas = 0;
            totalFestivaDiurna = 0;
            totalFestivaNocturna = 0;
            totalExtraFestiva = 0;
            totalDevengado = 0;

            // Calcular cada jornada
            const jornadas = document.querySelectorAll('.jornada-item');
            if (jornadas.length === 0) {
                alert('Por favor, agrega al menos una jornada para calcular.');
                return;
            }

            jornadas.forEach(jornada => {
                const jornadaId = jornada.id;
                calcularJornada(jornadaId);
            });

            // Mostrar resultados generales
            mostrarResultados();
        }

        // Función para mostrar los resultados acumulados
        function mostrarResultados() {
            const format = (valor) => '$' + Math.round(valor).toLocaleString('es-CO'); // Ensure Math.round for format

            const horaValor = salarioBase / 240;

            // ... (Existing calculations for totalHorasOrdinarias, totalHorasNocturnas, etc., leading to totalDevengado)
            // Ensure totalDevengado is calculated accurately here based on all hour types.
            // This part is assumed to be correct from previous structure.
            // Example:
            const valorOrdinario = Math.round(totalHorasOrdinarias * horaValor);
            const valorNocturno = Math.round(totalHorasNocturnas * horaValor * 1.35);
            const valorExtrasDiurnas = Math.round(totalExtrasDiurnas * horaValor * 1.25);
            const valorExtrasNocturnas = Math.round(totalExtrasNocturnas * horaValor * 1.75);
            const valorFestivaDiurna = Math.round(totalFestivaDiurna * horaValor * 2.00);
            const valorFestivaNocturna = Math.round(totalFestivaNocturna * horaValor * 2.10);
            const valorExtraFestiva = Math.round(totalExtraFestiva * horaValor * 2.50);

            totalDevengado = valorOrdinario + valorNocturno + valorExtrasDiurnas +
                            valorExtrasNocturnas + valorFestivaDiurna +
                            valorFestivaNocturna + valorExtraFestiva;
            // (End of example totalDevengado calculation)


            // Update the "DESGLOSE DE HORAS Y RECARGOS" table
            document.getElementById('horasOrdinarias').textContent = totalHorasOrdinarias;
            document.getElementById('valorOrdinario').textContent = format(valorOrdinario);
            document.getElementById('horasNocturnas').textContent = totalHorasNocturnas;
            document.getElementById('valorNocturno').textContent = format(valorNocturno);
            document.getElementById('extrasDiurnas').textContent = totalExtrasDiurnas;
            document.getElementById('valorExtrasDiurnas').textContent = format(valorExtrasDiurnas);
            document.getElementById('extrasNocturnas').textContent = totalExtrasNocturnas;
            document.getElementById('valorExtrasNocturnas').textContent = format(valorExtrasNocturnas);
            document.getElementById('festivaDiurna').textContent = totalFestivaDiurna;
            document.getElementById('valorFestivaDiurna').textContent = format(valorFestivaDiurna);
            document.getElementById('festivaNocturna').textContent = totalFestivaNocturna;
            document.getElementById('valorFestivaNocturna').textContent = format(valorFestivaNocturna);
            document.getElementById('horaExtraFestiva').textContent = totalExtraFestiva;
            document.getElementById('valorExtraFestiva').textContent = format(valorExtraFestiva);
            document.getElementById('detalleTotal').textContent = format(totalDevengado);

            // Handle Prestaciones Sociales based on prestacionesActivas state
            const beneficiosContainer = document.getElementById('beneficios-container');
            let prestacionesParaResumen; // This will be passed to calcularResumen

            if (prestacionesActivas) {
                if (beneficiosContainer) beneficiosContainer.style.display = 'block';
                // calcularPrestaciones updates its own table and returns the total
                prestacionesParaResumen = calcularPrestaciones(totalDevengado);
            } else {
                if (beneficiosContainer) beneficiosContainer.style.display = 'none';
                // Even if hidden, we might want to calculate it for internal consistency or if other parts depend on it.
                // However, for the summary, it must be 0.
                // Let's assume calcularPrestaciones doesn't have side effects beyond its own table if hidden.
                // Forcing $0 in summary is key.
                calcularPrestaciones(totalDevengado); // Calculate to update its own table (though hidden)
                prestacionesParaResumen = 0; // Value for RESUMEN DE PAGO and NETO A PAGAR
            }

            const deduccionesCalculadas = calcularDeducciones(totalDevengado);
            calcularResumen(totalDevengado, prestacionesParaResumen, deduccionesCalculadas);

            // Show result containers (beneficios-container display is now handled above)
            document.getElementById('resultados-container').style.display = 'block';
            // beneficios-container display is set based on prestacionesActivas
            document.getElementById('deducciones-container').style.display = 'block';
            document.getElementById('resumen-container').style.display = 'block';
        }

        // Función para calcular prestaciones sociales (sobre el total devengado)
        function calcularPrestaciones(totalDevengado) {
            const format = (valor) => '$' + Math.round(valor).toLocaleString('es-CO');

            // Calculamos sobre el total devengado
            const prima = totalDevengado * 0.0833; // 8.33% del total devengado
            const cesantias = totalDevengado * 0.0833; // 8.33% del total devengado
            const interesesCesantias = cesantias * 0.01; // 1% de las cesantías

            const totalPrestaciones = prima + cesantias + interesesCesantias;

            document.getElementById('prima').textContent = format(prima);
            document.getElementById('cesantias').textContent = format(cesantias);
            document.getElementById('intereses-cesantias').textContent = format(interesesCesantias);
            document.getElementById('total-prestaciones').textContent = format(totalPrestaciones);

            return totalPrestaciones;
        }

        function calcularDescansoRemunerado(salarioBaseIngresado, numDiasDescanso) {
            const dias = parseInt(numDiasDescanso, 10); // Ensure numDiasDescanso is an integer
            const salario = parseFloat(salarioBaseIngresado);

            if (salario > 0 && dias > 0) {
                // Calculate value of one day's pay and multiply by number of rest days
                // Use Math.round to handle potential floating point inaccuracies for currency.
                return Math.round((salario / 30) * dias);
            }
            return 0; // Return 0 if inputs are not valid or non-positive
        }

        function calcularRodamientoTotal(valorRodamientoDiario, numeroDeJornadas) {
            const valorDiario = parseFloat(valorRodamientoDiario);
            const jornadas = parseInt(numeroDeJornadas, 10); // Should be an integer already from contadorJornadas

            if (valorDiario > 0 && jornadas > 0) {
                // Multiply daily rodamiento value by number of jornadas
                // Use Math.round for currency.
                return Math.round(valorDiario * jornadas);
            }
            return 0; // Return 0 if inputs are not valid or non-positive
        }

        function calcularSubsidioTransporte(salarioBaseIngresado, numeroDeJornadas) {
            if (numeroDeJornadas <= 0) { // No subsidy if no jornadas worked
                return 0;
            }
            if (salarioBaseIngresado > 0 && salarioBaseIngresado < (2 * SALARIO_MINIMO_COLOMBIA)) {
                // Prorate the subsidy: (Total Subsidy / 30 days) * Number of Jornadas
                // Use Math.round to avoid fractional cents for the final subsidy amount.
                return Math.round((SUBSIDIO_TRANSPORTE_MONTO / 30) * numeroDeJornadas);
            }
            return 0; // Not eligible by salary
        }

        // Función para calcular deducciones (sobre el total devengado)
        function calcularDeducciones(totalDevengado) {
            const format = (valor) => '$' + Math.round(valor).toLocaleString('es-CO');

            const saludEmpleado = totalDevengado * 0.04;
            const pensionEmpleado = totalDevengado * 0.04;
            const totalDeducciones = saludEmpleado + pensionEmpleado;

            document.getElementById('salud-empleado').textContent = format(saludEmpleado);
            document.getElementById('pension-empleado').textContent = format(pensionEmpleado);
            document.getElementById('total-deducciones').textContent = format(totalDeducciones);

            return totalDeducciones;
        }

        // Función para calcular resumen
        function calcularResumen(totalDevengado, totalPrestacionesNumerico, totalDeduccionesNumerico) {
            const format = (valor) => '$' + Math.round(valor).toLocaleString('es-CO');

            const diasDescansoInput = document.getElementById('diasDescanso').value;
            const valorRodamientoDiarioInput = document.getElementById('valorRodamientoDiario').value;

            const diasDescansoValue = parseInt(diasDescansoInput, 10) || 0;
            const valorRodamientoDiarioValue = parseFloat(valorRodamientoDiarioInput) || 0;

            const descansoRemuneradoValor = calcularDescansoRemunerado(salarioBase, diasDescansoValue);
            const rodamientoTotalValor = calcularRodamientoTotal(valorRodamientoDiarioValue, contadorJornadas);
            const subsidioTransporteValor = calcularSubsidioTransporte(salarioBase, contadorJornadas);

            // Use the passed-in numerical values directly
            // Ensure they are numbers, default to 0 if undefined/NaN (though should be provided by mostrarResultados)
            const prestaciones = Number(totalPrestacionesNumerico) || 0;
            const deducciones = Number(totalDeduccionesNumerico) || 0;

            const netoPagar = totalDevengado + prestaciones - deducciones +
                                subsidioTransporteValor + descansoRemuneradoValor + rodamientoTotalValor;

            document.getElementById('resumen-devengado').textContent = format(totalDevengado);
            // Update summary table display fields with the accurate numerical values
            document.getElementById('resumen-prestaciones').textContent = format(prestaciones);
            document.getElementById('resumen-deducciones').textContent = format(deducciones);

            document.getElementById('resumen-descanso-remunerado').textContent = format(descansoRemuneradoValor);
            document.getElementById('resumen-rodamientos').textContent = format(rodamientoTotalValor);
            document.getElementById('resumen-subsidio-transporte').textContent = format(subsidioTransporteValor);

            document.getElementById('neto-pagar').textContent = format(netoPagar);
        }

        function guardarProgreso() {
            const data = {
                salarioBase: document.getElementById('salarioBase').value || "",
                diasDescanso: document.getElementById('diasDescanso').value || "",
                valorRodamientoDiario: document.getElementById('valorRodamientoDiario').value || "",
                jornadas: []
            };

            const jornadaItems = document.querySelectorAll('#jornadas-container .jornada-item');
            jornadaItems.forEach(item => {
                // Assuming the input IDs within each jornada-item follow a pattern.
                // When agregarJornada creates items like 'jornada-1', the inputs are 'jornada-1-fechaIngreso', etc.
                // We need to extract the base ID of the item (e.g., 'jornada-1') to find its children.
                const itemId = item.id; // e.g., "jornada-1", "jornada-2"
                const fechaIngresoElem = document.getElementById(`${itemId}-fechaIngreso`);
                const fechaSalidaElem = document.getElementById(`${itemId}-fechaSalida`);

                if (fechaIngresoElem && fechaSalidaElem) {
                    data.jornadas.push({
                        fechaIngreso: fechaIngresoElem.value,
                        fechaSalida: fechaSalidaElem.value
                    });
                }
            });

            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'calculadora_nomina_progreso.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);

            // Optional: alert or message user
            // alert('Progreso guardado como calculadora_nomina_progreso.json');
        }

        function cargarProgreso(data) {
            // Basic validation of the data structure
            if (!data || typeof data.salarioBase === 'undefined' || typeof data.jornadas === 'undefined' || !Array.isArray(data.jornadas)) {
                alert('Error: El archivo de progreso no tiene el formato esperado.');
                return;
            }

            // Clear existing calculator state
            resetTodo();

            // Repopulate main input fields
            // Use data.hasOwnProperty to ensure the property exists before assigning
            if (data.hasOwnProperty('salarioBase')) {
                document.getElementById('salarioBase').value = data.salarioBase;
            }
            if (data.hasOwnProperty('diasDescanso')) {
                document.getElementById('diasDescanso').value = data.diasDescanso;
            }
            if (data.hasOwnProperty('valorRodamientoDiario')) {
                document.getElementById('valorRodamientoDiario').value = data.valorRodamientoDiario;
            }

            // Repopulate jornadas
            // Note: resetTodo() sets contadorJornadas to 0.
            // agregarJornada() increments contadorJornadas *before* creating the element ID.
            // So, the first jornada added will be 'jornada-1', second 'jornada-2', etc.
            data.jornadas.forEach(jornadaData => {
                if (jornadaData && typeof jornadaData.fechaIngreso !== 'undefined' && typeof jornadaData.fechaSalida !== 'undefined') {
                    agregarJornada(); // This creates a new jornada item and increments contadorJornadas

                    // The newly added jornada will have an ID like 'jornada-' + contadorJornadas
                    // (assuming agregarJornada updates contadorJornadas correctly before we use it here)
                    // Let's ensure IDs are correct: agregarJornada sets h3 to "Jornada X", where X is current contadorJornadas
                    const currentJornadaIdSuffix = contadorJornadas; // contadorJornadas is now the number of the one just added

                    const ingresoInput = document.getElementById(`jornada-${currentJornadaIdSuffix}-fechaIngreso`);
                    const salidaInput = document.getElementById(`jornada-${currentJornadaIdSuffix}-fechaSalida`);

                    if (ingresoInput && salidaInput) {
                        ingresoInput.value = jornadaData.fechaIngreso;
                        salidaInput.value = jornadaData.fechaSalida;
                    } else {
                        console.warn(`No se encontraron los campos de fecha para la jornada ${currentJornadaIdSuffix} durante la importación.`);
                    }
                } else {
                    console.warn("Datos de jornada incompletos en el archivo importado:", jornadaData);
                }
            });

            alert('Progreso cargado exitosamente. Por favor, haga clic en "Calcular Todas" para ver los resultados.');
        }

        function togglePrestaciones() {
            prestacionesActivas = !prestacionesActivas; // Invert the state

            const btnToggle = document.getElementById('btnTogglePrestaciones');
            if (btnToggle) {
                btnToggle.textContent = prestacionesActivas ? 'Prestaciones: ON' : 'Prestaciones: OFF';
            }

            // Recalculate everything to reflect the change
            // Need to ensure salarioBase has a value if no jornadas are present,
            // or that calcularTodasJornadas handles it.
            // For now, assume it's okay to call, or user has already input salary.
            if (document.getElementById('salarioBase').value) { // Only recalculate if salary base is entered
                 calcularTodasJornadas();
            } else {
                // If no salary is entered, just update button and visibility of the section
                // (visibility part will be handled in mostrarResultados based on prestacionesActivas)
                // but we might need to manually refresh parts of the display if calcularTodasJornadas is skipped.
                // For simplicity now, we'll rely on calcularTodasJornadas.
                // A more refined approach might be to just call mostrarResultados if totalDevengado is already computed
                // and only the summary needs re-evaluation.
                // However, if no calculation has run, there's nothing to update in the summary anyway.
                // Let's ensure the card visibility is handled even if calculation doesn't run.
                const beneficiosContainer = document.getElementById('beneficios-container');
                if (beneficiosContainer) {
                    beneficiosContainer.style.display = prestacionesActivas ? 'block' : 'none';
                }
                // If we hide it here, also need to ensure resumen-prestaciones is $0 if no recalc
                // This is getting complex, better to ensure calcularTodasJornadas or mostrarResultados runs.
                // Let's stick to the plan: call calcularTodasJornadas, which calls mostrarResultados.
                // The user should have salary and jornadas if they want meaningful output.
                // If they toggle before calculating, the effect will be seen on the *next* calculation.
                // This is acceptable.
                // The most direct impact of the toggle without a full recalc would be on an *existing* calculation.
                // So, if a calculation is already displayed, we want to refresh it.

                // Let's refine: if results are visible, then recalculate. Otherwise, the change applies at next calculation.
                if (document.getElementById('resultados-container').style.display === 'block') {
                     calcularTodasJornadas();
                }
            }
        }

        // Función para resetear todo
        function resetTodo() {
            document.getElementById('jornadas-container').innerHTML = '';
            document.getElementById('salarioBase').value = '';
            document.getElementById('diasDescanso').value = '';
            document.getElementById('valorRodamientoDiario').value = '';
            contadorJornadas = 0;
            salarioBase = 0;

            // Reset Prestaciones Sociales toggle state and button
            prestacionesActivas = true; // Reset to default state (ON)
            const btnTogglePrestacionesElem = document.getElementById('btnTogglePrestaciones');
            if (btnTogglePrestacionesElem) {
                btnTogglePrestacionesElem.textContent = 'Prestaciones: ON';
            }

            // Resetear acumuladores
            totalHorasOrdinarias = 0;
            totalHorasNocturnas = 0;
            totalExtrasDiurnas = 0;
            totalExtrasNocturnas = 0;
            totalFestivaDiurna = 0;
            totalFestivaNocturna = 0;
            totalExtraFestiva = 0;
            totalDevengado = 0;

            // Resetear tablas
            [
                'horasOrdinarias', 'valorOrdinario',
                'horasNocturnas', 'valorNocturno',
                'extrasDiurnas', 'valorExtrasDiurnas',
                'extrasNocturnas', 'valorExtrasNocturnas',
                'festivaDiurna', 'valorFestivaDiurna',
                'festivaNocturna', 'valorFestivaNocturna',
                'horaExtraFestiva', 'valorExtraFestiva',
                'detalleTotal',
                'prima', 'cesantias', 'intereses-cesantias', 'total-prestaciones',
                'salud-empleado', 'pension-empleado', 'total-deducciones',
                'resumen-devengado', 'resumen-prestaciones', 'resumen-deducciones',
                'resumen-descanso-remunerado',
                'resumen-rodamientos',
                'resumen-subsidio-transporte', 'neto-pagar'
            ].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = id.startsWith('valor') || id.startsWith('total') || id.startsWith('resumen') || id.startsWith('neto') ? '$0' : '0';
            });

            // Ocultar secciones de resultados
            document.getElementById('resultados-container').style.display = 'none';
            document.getElementById('beneficios-container').style.display = 'none';
            document.getElementById('deducciones-container').style.display = 'none';
            document.getElementById('resumen-container').style.display = 'none';
        }

        // Agregar una jornada inicial al cargar la página
        window.onload = function() {
            agregarJornada(); // Keep existing functionality

            // Attach event listener for Guardar Progreso
            const btnGuardar = document.getElementById('btnGuardarProgreso');
            if (btnGuardar) {
                btnGuardar.addEventListener('click', guardarProgreso);
            }

            const btnImportar = document.getElementById('btnImportarProgreso');
            const importFileInput = document.getElementById('importFile');

            if (btnImportar && importFileInput) {
                btnImportar.addEventListener('click', function() {
                    importFileInput.click();
                });
            }

            if (importFileInput) {
                importFileInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (!file) {
                        return; // No file selected
                    }
                    if (file.type !== 'application/json') {
                        alert('Por favor, seleccione un archivo .json válido.');
                        event.target.value = null; // Reset file input
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            // Call cargarProgreso (to be implemented in next step)
                            cargarProgreso(jsonData);
                        } catch (error) {
                            alert('Error al leer el archivo: Formato JSON inválido.\n' + error.message);
                        } finally {
                            // Reset file input to allow re-importing the same file if needed
                            event.target.value = null;
                        }
                    };
                    reader.onerror = function() {
                        alert('Error al leer el archivo.');
                        event.target.value = null; // Reset file input
                    };
                    reader.readAsText(file);
                });
            }

            const btnTogglePrestacionesElem = document.getElementById('btnTogglePrestaciones');
            if (btnTogglePrestacionesElem) {
                btnTogglePrestacionesElem.addEventListener('click', togglePrestaciones);
            }
        };
    </script>
</body>
</html>
